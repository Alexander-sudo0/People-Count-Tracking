<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI People Counter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-900 text-white font-sans h-screen flex">

    <div class="w-64 flex-shrink-0 bg-gray-800 border-r border-gray-700 flex flex-col h-screen">
        <div class="p-6 border-b border-gray-700 flex-shrink-0">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="eye" class="text-green-400"></i> InsightCount
                </h1>
                <div class="flex gap-2 text-sm">
                    <a href="/video_analysis" class="text-gray-400 hover:text-white">Videos</a>
                    <a href="/settings" class="text-gray-400 hover:text-white">Settings</a>
                </div>
            </div>
        </div>
        
        <div class="flex-1 flex flex-col overflow-hidden">
            <div class="p-4 border-b border-gray-700 flex-shrink-0">
                <p class="text-xs text-gray-400 uppercase font-semibold mb-2">Add Stream</p>
                <div class="space-y-2 text-sm">
                    <input type="text" id="rtspUrl" placeholder="RTSP URL or ID" 
                           class="w-full bg-gray-700 text-xs rounded px-3 py-1 outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="camName" placeholder="Name" 
                           class="w-full bg-gray-700 text-xs rounded px-3 py-1 outline-none focus:ring-2 focus:ring-green-500">
                    <div class="flex gap-1">
                        <input type="number" id="processFps" value="5" min="1" class="w-16 bg-gray-700 text-xs rounded px-2 py-1">
                        <select id="addTimeWindow" class="bg-gray-700 text-xs rounded px-2 py-1 flex-1">
                            <option value="1">1h</option>
                            <option value="6">6h</option>
                            <option value="24">24h</option>
                        </select>
                    </div>
                    <label class="flex items-center gap-2 text-xs"><input type="checkbox" id="countingEnabled" checked> Count</label>
                    <button onclick="addCamera()" class="w-full bg-green-600 hover:bg-green-500 rounded px-2 py-1 text-xs">Add</button>
                    <button onclick="addWebcam()" class="w-full bg-indigo-600 hover:bg-indigo-500 rounded px-2 py-1 text-xs">Built-in</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 border-b border-gray-700">
                <p class="text-xs text-gray-400 uppercase font-semibold mb-2">Cameras</p>
                <div id="cameraList" class="space-y-2">
                    {% for cam in cameras %}
                    <div class="w-full text-left bg-gray-700 hover:bg-gray-600 p-2 rounded flex items-center gap-2 transition text-xs">
                        <input type="checkbox" class="bg-gray-600 w-4 h-4" onchange="toggleCounting('{{ cam.id }}', this.checked)" {% if cam.counting_enabled %}checked{% endif %} title="Toggle counting">
                        <button onclick="selectCamera('{{ cam.id }}')" class="flex-1 text-left min-w-0">
                            <span class="truncate">{{ cam.name }}</span>
                        </button>
                        <button onclick="editCamera('{{ cam.id }}')" class="bg-gray-600 rounded px-1 py-0 text-xs flex-shrink-0">E</button>
                        <button onclick="deleteCamera('{{ cam.id }}')" class="bg-red-600 hover:bg-red-500 rounded px-1 py-0 text-xs flex-shrink-0">Ã—</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="p-3 border-t border-gray-700 text-xs text-gray-500 flex-shrink-0">
            System: <span class="text-green-400">Online</span>
        </div>
    </div>

    <div class="flex-1 flex flex-col min-w-0">
        <header class="bg-gray-800 border-b border-gray-700 h-16 flex items-center justify-between px-8">
            <h2 class="text-lg font-medium" id="currentCamName">Dashboard</h2>
            <div class="flex items-center gap-4">
                <span class="flex h-3 w-3 relative">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                </span>
                <span class="text-sm font-mono text-gray-300">LIVE FEED</span>
                <button onclick="toggleLogsPanel()" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">ðŸ“Š Logs</button>
            </div>
        </header>

        <main class="flex-1 min-h-0 p-4 flex flex-col lg:flex-row gap-4 overflow-hidden">
            
            <div class="flex-1 min-h-0 bg-black rounded-lg overflow-hidden border border-gray-700 relative shadow-2xl flex items-center justify-center min-w-0">
                <div id="videoContainer" class="relative w-full h-full flex items-center justify-center">
                    <img id="videoStream" src="" class="w-full h-full object-contain hidden">
                    <canvas id="roiCanvas" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden cursor-crosshair border-2 border-red-500 bg-black bg-opacity-30"></canvas>
                    <div id="placeholder" class="text-gray-500 flex flex-col items-center">
                        <i data-lucide="camera-off" class="w-12 h-12 mb-4"></i>
                        <p>Select a camera to view feed</p>
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-80 flex flex-col gap-3 overflow-y-auto">
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 shadow-lg flex-shrink-0">
                    <h3 class="text-gray-400 text-sm font-semibold uppercase mb-2">Unique Visitors</h3>
                    <div class="flex items-end gap-2">
                        <span id="uniqueCount" class="text-5xl font-bold text-white">0</span>
                        <span class="text-green-400 text-sm mb-1 font-medium">â–² Active</span>
                    </div>
                </div>

                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700 flex-shrink-0">
                    <h3 class="text-gray-400 text-xs font-semibold uppercase mb-2">Camera Controls</h3>
                    <div class="space-y-2 text-sm">
                        <input type="text" id="editCamName" placeholder="Camera Name" class="w-full bg-gray-700 text-xs rounded px-2 py-1 outline-none">
                        <label class="flex items-center gap-2 text-xs"><input type="checkbox" id="editCountingEnabled"> Enable Counting</label>
                        <div class="flex items-center gap-2">
                            <label class="text-xs">Time:</label>
                            <select id="editTimeWindow" class="bg-gray-700 text-xs rounded px-2 py-1 flex-1">
                                <option value="1">1h</option>
                                <option value="6">6h</option>
                                <option value="24">24h</option>
                            </select>
                        </div>
                        <label class="flex items-center gap-2 text-xs">
                            <input type="checkbox" id="editLineCrossingEnabled" onchange="toggleLineCrossing()"> Enable Line Crossing
                        </label>
                        <div id="lineCrossingControls" class="hidden space-y-1 text-xs">
                            <label class="text-gray-400">Line Position: <span id="linePosLabel">50%</span></label>
                            <input type="range" id="linePosSlider" min="0" max="100" value="50" class="w-full bg-gray-700 rounded" onchange="setLinePosition()">
                            <div class="text-gray-400 text-xs">Line Crossings: <span id="lineCrossCount">0</span></div>
                        </div>
                        <div class="border-t border-gray-600 pt-2 mt-2">
                            <p class="text-gray-400 text-xs font-semibold mb-2">ROI & Perimeter</p>
                            <div class="space-y-1">
                                <button id="roiToggleBtn" onclick="toggleROIMode()" class="w-full bg-purple-600 hover:bg-purple-500 rounded px-2 py-1 text-xs">Draw ROI (Click to draw)</button>
                                <button id="rotToggleBtn" onclick="toggleROTMode()" class="w-full bg-indigo-600 hover:bg-indigo-500 rounded px-2 py-1 text-xs">Draw Perimeter</button>
                                <button onclick="clearROI()" class="w-full bg-red-600 hover:bg-red-500 rounded px-2 py-1 text-xs">Clear All</button>
                                <div id="roiStatus" class="text-gray-400 text-xs mt-1">No ROI set</div>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <input type="number" id="editFps" min="1" class="bg-gray-700 text-xs rounded px-2 py-1 w-16">
                            <button onclick="saveCameraChanges()" class="flex-1 bg-blue-600 hover:bg-blue-500 rounded text-xs py-1">Save</button>
                        </div>
                        <button onclick="fetchFaces()" class="w-full bg-gray-700 hover:bg-gray-600 rounded px-2 py-1 text-xs">View Faces</button>
                    </div>
                </div>

                <div id="facesPanel" class="bg-gray-800 p-3 rounded-lg border border-gray-700 overflow-auto max-h-60 flex-shrink-0 hidden">
                    <h3 class="text-gray-400 text-sm font-semibold uppercase mb-2">Identified Faces (Clustered)</h3>
                    <div id="facesGrid" class="grid grid-cols-1 gap-2"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        lucide.createIcons();
        let currentCamId = null;

        // Load the first camera if available
        {% if cameras %}
            selectCamera("{{ cameras[0].id }}");
        {% endif %}

        function selectCamera(camId) {
            currentCamId = camId;
            const img = document.getElementById('videoStream');
            const placeholder = document.getElementById('placeholder');
            
            // Update Video Source
            img.src = `/video_feed/${camId}`;
            img.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            document.getElementById('currentCamName').innerText = `Camera ID: ${camId}`;

            // Fetch stats to populate controls (includes time window)
            fetch(`/stats/${camId}`).then(r => r.json()).then(data => {
                document.getElementById('uniqueCount').innerText = data.unique_count_1hr || 0;
                document.getElementById('editCamName').value = data.name || '';
                document.getElementById('editFps').value = data.process_fps || 5;
                document.getElementById('editCountingEnabled').checked = !!data.counting_enabled;
                // populate time window selector (hours)
                const tw = data.time_window_seconds || 3600;
                const hours = Math.round(tw / 3600);
                if(document.getElementById('editTimeWindow')) document.getElementById('editTimeWindow').value = hours;
                const facesHeader = document.querySelector('#facesPanel h3');
                if(facesHeader) facesHeader.innerText = `Identified Faces (${hours} hr)`;
                
                // Update line-crossing controls
                document.getElementById('editLineCrossingEnabled').checked = !!data.line_crossing_enabled;
                const lineCrossingControls = document.getElementById('lineCrossingControls');
                if(data.line_crossing_enabled) {
                    lineCrossingControls.classList.remove('hidden');
                    document.getElementById('linePosSlider').value = Math.round((data.line_position || 0.5) * 100);
                    document.getElementById('linePosLabel').innerText = Math.round((data.line_position || 0.5) * 100) + '%';
                } else {
                    lineCrossingControls.classList.add('hidden');
                }
            });
        }

        // Toggle counting for a camera inline
        function toggleCounting(camId, enabled) {
            const form = new FormData();
            form.append('counting_enabled', enabled ? 'true' : 'false');
            fetch(`/camera/${camId}/update`, { method: 'POST', body: form }).then(() => {
                // Optionally refresh stats for current selected camera
                if(currentCamId === camId) selectCamera(camId);
            });
        }

        function editCamera(camId) {
            selectCamera(camId);
            // scroll to top so camera controls are visible
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function addWebcam(){
            const form = new FormData();
            form.append('source', '0');
            form.append('name', document.getElementById('camName').value || 'Built-in Webcam');
            form.append('process_fps', document.getElementById('processFps').value || 5);
            form.append('time_window_hours', document.getElementById('addTimeWindow').value || 1);
            form.append('counting_enabled', document.getElementById('countingEnabled').checked ? 'true' : 'false');
            fetch('/add_camera', { method: 'POST', body: form }).then(res => { if(res.ok) location.reload(); });
        }

        async function addCamera() {
            const source = document.getElementById('rtspUrl').value;
            const name = document.getElementById('camName').value;
            const fps = document.getElementById('processFps').value || 5;
            const timeWindowHours = document.getElementById('addTimeWindow').value || 1;
            const counting = document.getElementById('countingEnabled').checked ? 'true' : 'false';

            if(!source) return;

            const formData = new FormData();
            formData.append('source', source);
            if(name) formData.append('name', name);
            formData.append('process_fps', fps);
            formData.append('time_window_hours', timeWindowHours);
            formData.append('counting_enabled', counting);

            const res = await fetch('/add_camera', { method: 'POST', body: formData });
            if(res.ok) {
                location.reload(); // Simple reload to update list
            }
        }

        async function saveCameraChanges() {
            if(!currentCamId) return;
            const name = document.getElementById('editCamName').value;
            const fps = parseInt(document.getElementById('editFps').value || '5');
            const counting = document.getElementById('editCountingEnabled').checked ? 'true' : 'false';
            const timeWindowHours = parseInt(document.getElementById('editTimeWindow').value || '1');

            const form = new FormData();
            if(name) form.append('name', name);
            form.append('counting_enabled', counting);

            await fetch(`/camera/${currentCamId}/update`, { method: 'POST', body: form });
            await fetch(`/camera/${currentCamId}/frequency`, { method: 'POST', body: new URLSearchParams({process_fps: fps}) });
            await fetch(`/camera/${currentCamId}/time_window`, { method: 'POST', body: new URLSearchParams({time_window_hours: timeWindowHours}) });

            // Refresh stats
            const res = await fetch(`/stats/${currentCamId}`);
            const data = await res.json();
            document.getElementById('uniqueCount').innerText = data.unique_count_1hr || 0;
            alert('Saved');
        }

        async function fetchFaces() {
            if(!currentCamId) return;
            const panel = document.getElementById('facesPanel');
            const grid = document.getElementById('facesGrid');
            panel.classList.remove('hidden');
            grid.innerHTML = '<div class="col-span-2 text-gray-400">Loading...</div>';
            const res = await fetch(`/faces/${currentCamId}`);
            const data = await res.json();
            grid.innerHTML = '';
            
            if(data.faces.length === 0) {
                grid.innerHTML = '<div class="col-span-2 text-gray-400">No faces in the last hour</div>';
                return;
            }
            
            // Display summary stats
            const statsDiv = document.createElement('div');
            statsDiv.className = 'col-span-2 bg-blue-900/30 rounded p-2 mb-2 border border-blue-700';
            statsDiv.innerHTML = `
                <div class="text-xs font-semibold text-blue-300">Unique People: ${data.unique_people_count}</div>
                <div class="text-xs text-gray-400">Total Face Events: ${data.total_face_events}</div>
            `;
            grid.appendChild(statsDiv);
            
            // Group faces by cluster
            const facesByCluster = {};
            data.faces.forEach(f => {
                if(!facesByCluster[f.cluster_id]) facesByCluster[f.cluster_id] = [];
                facesByCluster[f.cluster_id].push(f);
            });
            
            // Display each cluster as a group
            Object.entries(facesByCluster).forEach(([clusterId, faces]) => {
                // Find cluster info
                const clusterInfo = data.clusters.find(c => c.cluster_id === clusterId);
                
                // Cluster header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'col-span-2 bg-green-900/30 rounded p-2 border border-green-700 mt-2';
                headerDiv.innerHTML = `
                    <div class="text-xs font-semibold text-green-300">${clusterId}</div>
                    <div class="text-xs text-gray-400">
                        Detections: ${clusterInfo?.face_count || faces.length} | 
                        Avg Quality: ${clusterInfo?.quality_avg || 'N/A'}
                    </div>
                    <div class="text-xs text-gray-500">
                        First: ${clusterInfo?.first_seen || 'N/A'} | Last: ${clusterInfo?.last_seen || 'N/A'}
                    </div>
                `;
                grid.appendChild(headerDiv);
                
                // Face events in this cluster
                faces.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 rounded p-2 flex flex-col items-start gap-1';
                    
                    const img = document.createElement('img');
                    img.className = 'w-full h-20 object-cover rounded';
                    img.src = f.image || '/static/faces/placeholder.png';
                    
                    const meta = document.createElement('div');
                    meta.className = 'w-full text-xs';
                    meta.innerHTML = `
                        <div class="font-medium text-white">${f.cluster_id}</div>
                        <div class="text-gray-400">Quality: ${f.quality} | Conf: ${f.confidence}</div>
                        <div class="text-gray-500">Captured: ${f.captured_at}</div>
                    `;
                    
                    div.appendChild(img);
                    div.appendChild(meta);
                    grid.appendChild(div);
                });
            });
        }

        async function deleteCamera(camId) {
            if(!confirm(`Delete camera? This cannot be undone.`)) {
                return;
            }
            
            const res = await fetch(`/camera/${camId}`, { method: 'DELETE' });
            if(res.ok) {
                location.reload();
            } else {
                alert('Failed to delete camera');
            }
        }

        // Poll for stats every 2 seconds
        setInterval(async () => {
            if(currentCamId) {
                const res = await fetch(`/stats/${currentCamId}`);
                const data = await res.json();
                document.getElementById('uniqueCount').innerText = data.unique_count_1hr;
                // Update line crossing count if enabled
                if(data.line_crossing_enabled) {
                    document.getElementById('lineCrossCount').innerText = data.unique_count_1hr || 0;
                }
            }
        }, 2000);

        async function toggleLineCrossing() {
            if(!currentCamId) return;
            const enabled = document.getElementById('editLineCrossingEnabled').checked;
            const form = new FormData();
            form.append('enabled', enabled ? 'true' : 'false');
            form.append('line_position', (parseInt(document.getElementById('linePosSlider').value || 50) / 100).toFixed(2));
            
            const res = await fetch(`/camera/${currentCamId}/line_crossing`, { method: 'POST', body: form });
            if(res.ok) {
                const controls = document.getElementById('lineCrossingControls');
                if(enabled) {
                    controls.classList.remove('hidden');
                } else {
                    controls.classList.add('hidden');
                }
            }
        }

        async function setLinePosition() {
            if(!currentCamId) return;
            const position = parseInt(document.getElementById('linePosSlider').value || 50) / 100;
            document.getElementById('linePosLabel').innerText = Math.round(position * 100) + '%';
            
            const form = new FormData();
            form.append('line_position', position.toFixed(2));
            await fetch(`/camera/${currentCamId}/line_position`, { method: 'POST', body: form });
        }

        // ROI & Perimeter Drawing Logic
        let roiMode = false, rotMode = false;
        let roiPoints = [], rotPoints = [];
        const canvas = document.getElementById('roiCanvas');
        const ctx = canvas.getContext('2d');
        const videoImg = document.getElementById('videoStream');

        function syncCanvasSize() {
            if(!videoImg.src || videoImg.classList.contains('hidden')) return;
            const rect = videoImg.getBoundingClientRect();
            canvas.width = videoImg.naturalWidth || 640;
            canvas.height = videoImg.naturalHeight || 480;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            redrawROI();
        }

        function toggleROIMode() {
            if(!currentCamId) return;
            roiMode = !roiMode;
            rotMode = false;
            roiPoints = [];
            document.getElementById('roiToggleBtn').classList.toggle('bg-green-600');
            document.getElementById('roiToggleBtn').classList.toggle('bg-purple-600');
            document.getElementById('rotToggleBtn').classList.remove('bg-green-600');
            document.getElementById('rotToggleBtn').classList.add('bg-indigo-600');
            canvas.classList.toggle('hidden', !roiMode);
            syncCanvasSize();
        }

        function toggleROTMode() {
            if(!currentCamId) return;
            rotMode = !rotMode;
            roiMode = false;
            rotPoints = [];
            document.getElementById('rotToggleBtn').classList.toggle('bg-green-600');
            document.getElementById('rotToggleBtn').classList.toggle('bg-indigo-600');
            document.getElementById('roiToggleBtn').classList.remove('bg-green-600');
            document.getElementById('roiToggleBtn').classList.add('bg-purple-600');
            canvas.classList.toggle('hidden', !rotMode);
            syncCanvasSize();
        }

        function clearROI() {
            roiPoints = [];
            rotPoints = [];
            roiMode = false;
            rotMode = false;
            canvas.classList.add('hidden');
            document.getElementById('roiToggleBtn').classList.remove('bg-green-600');
            document.getElementById('roiToggleBtn').classList.add('bg-purple-600');
            document.getElementById('rotToggleBtn').classList.remove('bg-green-600');
            document.getElementById('rotToggleBtn').classList.add('bg-indigo-600');
            document.getElementById('roiStatus').innerText = 'No ROI set';
            // Send clear ROI to server
            if(currentCamId) {
                const form = new FormData();
                form.append('roi_points', JSON.stringify([]));
                form.append('rot_points', JSON.stringify([]));
                fetch(`/camera/${currentCamId}/roi`, { method: 'POST', body: form });
            }
            redrawROI();
        }

        function redrawROI() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw ROI rectangle (green)
            if(roiPoints.length > 0) {
                ctx.strokeStyle = '#00FF00';
                ctx.lineWidth = 3;
                for(let i = 0; i < roiPoints.length; i++) {
                    const p = roiPoints[i];
                    const p2 = roiPoints[(i + 1) % roiPoints.length];
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                    ctx.fillStyle = '#00FF00';
                    ctx.fillRect(p.x - 4, p.y - 4, 8, 8);
                }
            }

            // Draw ROT perimeter (red)
            if(rotPoints.length > 0) {
                ctx.strokeStyle = '#FF0000';
                ctx.lineWidth = 3;
                for(let i = 0; i < rotPoints.length; i++) {
                    const p = rotPoints[i];
                    const p2 = rotPoints[(i + 1) % rotPoints.length];
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(p.x - 4, p.y - 4, 8, 8);
                }
            }
        }

        canvas.addEventListener('click', (e) => {
            if(!roiMode && !rotMode) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            if(roiMode) {
                if(roiPoints.length < 4) {
                    roiPoints.push({x, y});
                    if(roiPoints.length === 4) {
                        saveROI();
                    }
                }
            } else if(rotMode) {
                rotPoints.push({x, y});
            }
            
            redrawROI();
        });

        canvas.addEventListener('dblclick', (e) => {
            if(rotMode && rotPoints.length >= 3) {
                saveROT();
                rotMode = false;
                canvas.classList.add('hidden');
                document.getElementById('rotToggleBtn').classList.remove('bg-green-600');
                document.getElementById('rotToggleBtn').classList.add('bg-indigo-600');
            }
        });

        async function saveROI() {
            if(!currentCamId || roiPoints.length !== 4) return;
            const form = new FormData();
            form.append('roi_points', JSON.stringify(roiPoints.map(p => [p.x / canvas.width, p.y / canvas.height])));
            const res = await fetch(`/camera/${currentCamId}/roi`, { method: 'POST', body: form });
            if(res.ok) {
                document.getElementById('roiStatus').innerText = 'ROI: 4 points set';
                roiMode = false;
                canvas.classList.add('hidden');
                document.getElementById('roiToggleBtn').classList.remove('bg-green-600');
                document.getElementById('roiToggleBtn').classList.add('bg-purple-600');
            }
        }

        async function saveROT() {
            if(!currentCamId || rotPoints.length < 3) return;
            const form = new FormData();
            form.append('rot_points', JSON.stringify(rotPoints.map(p => [p.x / canvas.width, p.y / canvas.height])));
            const res = await fetch(`/camera/${currentCamId}/roi`, { method: 'POST', body: form });
            if(res.ok) {
                document.getElementById('roiStatus').innerText = `Perimeter: ${rotPoints.length} points set`;
            }
        }

        // Logs Panel Functions
        function toggleLogsPanel() {
            const panel = document.getElementById('logsPanel');
            if(panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                fetchLogs();
            } else {
                panel.classList.add('hidden');
            }
        }

        async function fetchLogs(eventType = null) {
            try {
                let url = '/logs?limit=100';
                if(eventType) url += `&event_type=${eventType}`;
                
                const res = await fetch(url);
                const data = await res.json();
                const logsContainer = document.getElementById('logsContainer');
                
                if(!data.logs || data.logs.length === 0) {
                    logsContainer.innerHTML = '<p class="text-gray-400 text-xs p-2">No logs yet. Run the counter to generate logs.</p>';
                    return;
                }
                
                // Display statistics
                const stats = data.stats || {};
                const statsHtml = `
                    <div class="bg-gray-700 p-2 rounded text-xs text-gray-200 mb-2">
                        <p><strong>Total Events:</strong> ${stats.total_events || 0}</p>
                        <p><strong>Distinct People:</strong> ${(stats.distinct_people || []).length}</p>
                        <p><strong>Face Matched:</strong> ${stats.events_by_type?.['face_matched'] || 0}</p>
                        <p><strong>New Person Created:</strong> ${stats.events_by_type?.['new_person_created'] || 0}</p>
                        <p><strong>Filtered Faces:</strong> ${stats.events_by_type?.['face_filtered'] || 0}</p>
                    </div>
                `;
                
                // Display detailed logs
                let logsHtml = statsHtml;
                data.logs.forEach(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString();
                    const event = log.event || 'unknown';
                    let details = '';
                    
                    switch(event) {
                        case 'face_detected':
                            details = `<span class="text-blue-300">Detected</span> | Size: ${log.face_size?.category || '?'} | Score: ${(log.detection_score || 0).toFixed(2)} | Frontal: ${log.is_frontal ? 'Yes' : 'No'}`;
                            break;
                        case 'face_matched':
                            details = `<span class="text-green-300">Matched</span> | Person: ${log.matched_person_id?.substring(0, 6)} | Score: ${(log.similarity_score || 0).toFixed(3)} | Method: ${log.match_method || 'unknown'} | Gallery Size: ${log.gallery_size || 0}`;
                            break;
                        case 'new_person_created':
                            details = `<span class="text-yellow-300">NEW PERSON</span> | Score: ${(log.detection_score || 0).toFixed(2)} | Size: ${log.reason || '?'}`;
                            break;
                        case 'face_filtered':
                            details = `<span class="text-red-300">Filtered</span> | Reason: ${log.reason || 'unknown'}`;
                            break;
                        case 'count_incremented':
                            details = `<span class="text-purple-300">Count +1</span> | Person: ${log.person_id?.substring(0, 6)}`;
                            break;
                        default:
                            details = `${event}`;
                    }
                    
                    logsHtml += `<div class="text-xs text-gray-300 p-1 border-b border-gray-700"><span class="text-gray-500">[${time}]</span> ${details}</div>`;
                });
                
                logsContainer.innerHTML = logsHtml;
            } catch(err) {
                console.error('Error fetching logs:', err);
            }
        }

        // Sync canvas size when video loads
        videoImg.addEventListener('load', syncCanvasSize);
        window.addEventListener('resize', syncCanvasSize);
    </script>

    <!-- Logs Panel Modal -->
    <div id="logsPanel" class="hidden fixed bottom-0 right-0 w-96 h-96 bg-gray-800 border-l-2 border-t-2 border-gray-700 rounded-tl-lg shadow-2xl flex flex-col z-50">
        <div class="bg-gray-700 p-3 border-b border-gray-600 flex justify-between items-center">
            <h3 class="font-semibold text-sm">Face Detection Logs</h3>
            <button onclick="toggleLogsPanel()" class="text-gray-400 hover:text-white text-lg">âœ•</button>
        </div>
        <div class="flex-1 overflow-y-auto p-2">
            <div id="logsContainer" class="text-xs text-gray-400">Loading...</div>
        </div>
        <div class="bg-gray-700 p-2 border-t border-gray-600 space-y-1">
            <div class="flex gap-1 text-xs">
                <button onclick="fetchLogs()" class="flex-1 bg-blue-600 hover:bg-blue-500 rounded px-2 py-1">All</button>
                <button onclick="fetchLogs('face_matched')" class="flex-1 bg-green-600 hover:bg-green-500 rounded px-2 py-1">Matched</button>
                <button onclick="fetchLogs('face_filtered')" class="flex-1 bg-red-600 hover:bg-red-500 rounded px-2 py-1">Filtered</button>
                <button onclick="fetchLogs('new_person_created')" class="flex-1 bg-yellow-600 hover:bg-yellow-500 rounded px-2 py-1">New</button>
            </div>
        </div>
    </div>
</body>
</html>